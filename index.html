<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dance Events</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;300;400;700&display=swap" rel="stylesheet">
</head>

<body>
    <div id="events-container"></div>
</body>

<script>
    const AIRTABLE_API_KEY = 'patkh9op2gMd1xAr3.4abbd851a95b9c5730b28b44545e91785328f840a92328b1b1fffd50868e566c';
    const BASE_ID = 'appMlyQoIVpWTzj79';
    const TABLE_NAME = 'tblzZL41j94BPih1Q';
    const API_URL = `https://api.airtable.com/v0/${BASE_ID}/${TABLE_NAME}`;
    const headers = { 'Authorization': `Bearer ${AIRTABLE_API_KEY}` };

    // Function to fetch all data from Airtable, handling pagination
    async function fetchEventData() {
        let allRecords = [];
        let offset = null;

        try {
            do {
                // Construct the API URL with or without the offset
                let url = API_URL;
                if (offset) {
                    url = `${API_URL}?offset=${offset}`;
                }

                console.log('Fetching events from Airtable...', url);

                const response = await fetch(url, { headers });
                const data = await response.json();

                console.log('Fetched events:', data.records);

                // Add fetched records to the allRecords array
                allRecords = allRecords.concat(data.records);

                // If there’s an offset in the response, prepare for the next page of records
                offset = data.offset;

            } while (offset);  // Keep fetching until there's no offset (i.e., no more pages)

            return allRecords;
        } catch (error) {
            console.error('Error fetching data:', error);
            alert('Could not load events. Check the console for details.');
            return [];
        }
    }

    // Function to get the next seven days starting from today
    function getWeekDays() {
        const weekDays = [];
        const daysOfWeek = ['DIMANCHE', 'LUNDI', 'MARDI', 'MERCREDI', 'JEUDI', 'VENDREDI', 'SAMEDI'];
        const today = new Date();

        for (let i = 0; i < 7; i++) {
            const nextDay = new Date(today);
            nextDay.setDate(today.getDate() + i);
            const dayName = daysOfWeek[nextDay.getDay()];
            const formattedDate = nextDay.toISOString().split('T')[0]; // Ensure YYYY-MM-DD format
            weekDays.push({ dayName, formattedDate });
        }

        console.log('Generated week days:', weekDays);
        return weekDays;
    }

    // Function to parse and normalize event date
    function normalizeEventDate(eventDateStr) {
        if (!eventDateStr) return null;

        // Try parsing the date
        const parsedDate = new Date(eventDateStr);
        
        // If the parsed date is invalid, log the error
        if (isNaN(parsedDate)) {
            console.error(`Invalid date: ${eventDateStr}`);
            return null;
        }
        
        // Return the date in YYYY-MM-DD format
        return parsedDate.toISOString().split('T')[0];
    }

    // Match an event's date with a target date
    function matchesTargetDate(eventDateStr, targetDate) {
        const eventDate = normalizeEventDate(eventDateStr);
        if (!eventDate) return false;

        // Trim any leading/trailing spaces and compare
        const eventDateTrimmed = eventDate.trim();
        const targetDateTrimmed = targetDate.trim();

        console.log(`Comparing event date "${eventDateTrimmed}" with target date "${targetDateTrimmed}"`);
        const isMatch = eventDateTrimmed === targetDateTrimmed;
        console.log(`Match result: ${isMatch ? 'true' : 'false'}`);
        return isMatch;
    }

    // Function to render the events of a specific day
    function renderEventsForDay(day, date, events) {
        const container = document.getElementById('events-container');

        const daySection = document.createElement('div');
        daySection.className = 'day-section';

        const headerDiv = document.createElement('div');
        headerDiv.className = 'header';

        const dayHeader = document.createElement('h1');
        dayHeader.className = 'day-of-week';
        dayHeader.textContent = day;
        headerDiv.appendChild(dayHeader);

        const dateHeader = document.createElement('p');
        dateHeader.className = 'date';
        dateHeader.textContent = date;
        headerDiv.appendChild(dateHeader);

        daySection.appendChild(headerDiv);

        const matchingEvents = events.filter(event => matchesTargetDate(event.fields.Date, date));
        console.log(`Events for ${day} (${date}):`, matchingEvents);

        if (matchingEvents.length === 0) {
            const noEventsMessage = document.createElement('p');
            noEventsMessage.textContent = 'Aucun événement prévu pour ce jour.';
            noEventsMessage.className = 'no-events';
            daySection.appendChild(noEventsMessage);
        } else {
            matchingEvents.forEach(event => {
                const fields = event.fields;

                const eventDiv = document.createElement('div');
                eventDiv.className = 'event';

                const eventDetailsDiv = document.createElement('div');
                eventDetailsDiv.className = 'event-details';

                const eventName = document.createElement('h2');
                eventName.textContent = fields['Event Name'] || 'Événement sans titre';
                eventName.className = 'event-name';
                eventDetailsDiv.appendChild(eventName);

                const location = document.createElement('p');
                location.textContent = fields['Location'] || 'Lieu non spécifié';
                location.className = 'location';
                eventDetailsDiv.appendChild(location);

                if (fields['Image URL']) {
                    const eventImage = document.createElement('img');
                    eventImage.src = fields['Image URL'];
                    eventImage.alt = `Image for ${fields['Event Name'] || 'Event'}`;
                    eventImage.className = 'event-image';
                    eventDiv.appendChild(eventImage);
                }

                eventDiv.onclick = () => {
                    sessionStorage.setItem('eventDetails', JSON.stringify(fields));
                    window.location.href = 'details.html';
                };

                eventDiv.appendChild(eventDetailsDiv);
                daySection.appendChild(eventDiv);
            });
        }

        container.appendChild(daySection);
    }

    // Fetch and display events for the next seven days starting from today
    async function updateEvents() {
        const events = await fetchEventData();
        const weekDays = getWeekDays();

        weekDays.forEach(({ dayName, formattedDate }) => {
            renderEventsForDay(dayName, formattedDate, events);
        });
    }

    updateEvents();
</script>

</html>